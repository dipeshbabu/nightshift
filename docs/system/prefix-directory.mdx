---
title: Prefix Directory
description: Anatomy of the Nightshift prefix directory and what each file does
---

<Warning>
  Nightshift is currently in its infancy and is subject to change and incompleteness.
  If you find a bug, or have an idea to improve Nightshift, please raise an issue on [Github](https://github.com/nightshiftco/nightshift/tree/main).
</Warning>

The prefix directory is Nightshift's root — everything it installs, generates, and tracks at runtime lives here. It is created by `nightshift install --prefix <path>` and used by all subsequent commands.

```
<prefix>/
├── bin/                      # Tool symlinks
├── tools/                    # Extracted tool binaries
├── uv-tools/                 # Tools installed via uv
├── python/                   # uv-managed Python installation
├── workspace/                # The agent's working directory
├── config/                   # XDG_CONFIG_HOME
├── share/                    # XDG_DATA_HOME
├── cache/                    # XDG_CACHE_HOME
├── state/                    # XDG_STATE_HOME
├── run/                      # PID files for running servers
├── agent_logs/               # Agent session logs
├── worktrees/                # Git worktrees for concurrent tasks
├── runs/                     # Persisted event streams (JSONL)
└── jobs/                     # Job metadata files
```

## Created at Install Time

These directories are set up by `nightshift install` and remain mostly static after that.

### `bin/`

Symlinks to all tool binaries. This directory is prepended to `PATH` at runtime so agents use Nightshift's tools instead of anything on the host system.

| Symlink | Target |
|---------|--------|
| `opencode` | `../tools/opencode/opencode` |
| `uv` | `../tools/uv/uv-<triple>/uv` |
| `rg` | `../tools/ripgrep/ripgrep-<version>-<triple>/rg` |

### `tools/`

Extracted tool binaries organized by tool name. Downloaded archives are cleaned up after extraction.

```
tools/
├── opencode/
│   └── opencode
├── uv/
│   └── uv-<triple>/uv
└── ripgrep/
    └── ripgrep-<version>-<triple>/rg
```

### `uv-tools/`

Tools installed via `uv tool install`. Currently contains **ty** (Python type checker).

```
uv-tools/
└── bin/
    └── ty
```

### `python/`

Where `uv` downloads and manages Python installations. Set via `UV_PYTHON_INSTALL_DIR`. With `UV_PYTHON_PREFERENCE=only-managed`, agents always use the Python version managed here rather than a system Python.

### `workspace/`

The agent's working directory. Contains the Python project, git repository, and OpenCode configuration. This is the default workspace path — it can be overridden in `nightshift.json` via the `workspacePath` field.

```
workspace/
├── pyproject.toml           # Python project config (managed by uv)
├── opencode.json            # OpenCode permissions config
├── AGENTS.md                # Agent instructions
├── README.md
├── src/nightshift_agent_lib/  # Agent-maintained library code
├── tests/                   # Tests
├── .venv/                   # Python virtual environment
└── .git/                    # Git repository (initialized at install)
```

The initial git commit created at install time is important — it establishes the baseline that [worktree](/worktrees) branches fork from.

### XDG Directories

Nightshift isolates OpenCode's configuration, data, cache, and state into the prefix so it doesn't collide with your system's XDG directories.

| Directory | Environment Variable | Purpose |
|-----------|---------------------|---------|
| `config/` | `XDG_CONFIG_HOME` | OpenCode configuration |
| `share/` | `XDG_DATA_HOME` | Persistent application data |
| `cache/` | `XDG_CACHE_HOME` | Cached data (models, downloads) |
| `state/` | `XDG_STATE_HOME` | Runtime state |

## Created at Runtime

These directories are created on-demand as Nightshift runs tasks.

### `run/`

PID files for active server processes. Each file is a JSON object with `pid` and `port` fields. Used to detect and reuse existing servers on restart, or clean up stale processes.

| File | Created By |
|------|-----------|
| `nightshift-worker.json` | Worker agent server (CLI mode) |
| `nightshift-boss.json` | Boss agent server (CLI mode) |
| `nightshift-worker-<shortId>.json` | Per-task worker server (serve mode) |
| `nightshift-boss-<shortId>.json` | Per-task boss server (serve mode) |
| `ralph-server.json` | Ralph HTTP daemon (TUI serve mode) |

```json
{ "pid": 12345, "port": 4532 }
```

PID files are removed when a server is intentionally stopped. If a process dies unexpectedly, Nightshift detects the stale PID file on next startup, kills the zombie (if still alive), and removes the file.

### `agent_logs/`

Session logs from worker and boss agents. Each log captures the full session output including text, tool invocations, and results.

| File Pattern | Source |
|-------------|--------|
| `agent_<commitHash>.log` | Worker session output |
| `evaluator_<commitHash>.log` | Boss session output |
| `ralph-server.log` | Ralph daemon stdout/stderr (TUI serve mode) |

The commit hash in the filename corresponds to the git state at the start of the session, making it easy to correlate logs with specific code changes.

### `worktrees/`

Git worktrees for concurrent task isolation. Each task gets its own worktree on a dedicated branch. See [Worktrees](/worktrees) for details.

```
worktrees/
├── task-a1b2c3d4e5f6g7h8/    # Active task worktree
└── task-f9e8d7c6b5a4c3d2/    # Another concurrent task
```

Worktrees are created when a task starts and removed when it finishes. On startup, `pruneStaleWorktrees()` cleans up any left behind by a crash.

### `runs/`

Persisted event streams for Ralph runs. Every event published during a run is appended to a JSONL file (one JSON object per line). This enables event replay via the `GET /runs/:runId/events` endpoint.

```
runs/
└── <runId>/
    └── events.jsonl
```

Each line in `events.jsonl` is a complete event object:

```json
{"type":"ralph.started","timestamp":1738000000000,"runId":"a1b2...","workspace":"/path","agentModel":"openai/gpt-5.2-codex","evalModel":"openai/gpt-5.2-codex"}
{"type":"loop.iteration.start","timestamp":1738000001000,"runId":"a1b2...","iteration":1}
{"type":"worker.start","timestamp":1738000002000,"runId":"a1b2...","commitHash":"abc1234"}
```

The last event's `type` field determines the run's status — `ralph.completed`, `ralph.error`, or `ralph.interrupted` are terminal events.

### `jobs/`

Job metadata files for the Ralph server's job management API. Each job is a JSON file tracking a prompt through its lifecycle.

```
jobs/
├── <jobId>.json
└── <jobId>.json
```

```json
{
  "id": "a1b2c3d4-...",
  "prompt": "Fix the failing tests in src/utils",
  "status": "completed",
  "runId": "f9e8d7c6-...",
  "runIds": ["f9e8d7c6-..."],
  "createdAt": 1738000000000
}
```

| Status | Meaning |
|--------|---------|
| `draft` | Job created but not yet started |
| `running` | Agent loop is actively working on this job |
| `completed` | Boss approved the task |
| `error` | An unrecoverable error occurred |
| `interrupted` | The user stopped the run |

Job status is automatically updated when terminal events (`ralph.completed`, `ralph.error`, `ralph.interrupted`) are published on the event bus.
